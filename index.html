<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pemesanan & Status Pembayaran</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            display: flex;
            flex-direction: column; /* Mengubah flex direction agar bisa ada 2 section */
            align-items: center;
            min-height: 100vh;
            margin: 20px 0; /* Memberi sedikit margin atas bawah */
            background-color: #f4f7f9;
            color: #333;
        }
        .container {
            background-color: #ffffff;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 500px; /* Sedikit lebih lebar untuk form */
            margin-bottom: 30px; /* Jarak antar container */
        }
        h1, h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            text-align: left;
        }
        input[type="text"], input[type="number"], select {
            width: calc(100% - 24px); /* Mempertimbangkan padding dan border */
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s ease;
            margin-top: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        #totalHargaDisplay, #paymentStatus {
            font-size: 1.5em;
            font-weight: bold;
            padding: 20px;
            margin-top: 15px;
            border-radius: 8px;
            min-height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            word-break: break-word;
        }
        .harga-display {
            background-color: #e9ecef;
            color: #007bff;
            border: 1px solid #ced4da;
        }
        .error-message {
            color: #dc3545;
            font-size: 0.9em;
            text-align: left;
            margin-top: -15px;
            margin-bottom: 10px;
        }
        /* Kelas status pembayaran yang sudah ada */
        .status-pending { background-color: #fef3cd; color: #664d03; border: 1px solid #ffeeba; }
        .status-success { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .status-error, .status-notfound { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
        .status-info { background-color: #cff4fc; color: #055160; border: 1px solid #b6effb; }
        
        hr {
            border: 0;
            height: 1px;
            background: #ddd;
            margin: 40px 0;
        }
        #lastChecked { font-size: 0.8em; color: #777; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container" id="orderFormContainer">
        <h1>üìù Form Pemesanan Akun</h1>
        
        <label for="kategoriAkun">1. Kategori Akun:</label>
        <select id="kategoriAkun">
            <option value="300">300 Followers</option>
            <option value="1000">1000 Followers</option>
        </select>

        <label for="jumlahAkun">2. Jumlah Akun (Minimal 3, Kelipatan 3):</label>
        <input type="number" id="jumlahAkun" placeholder="Contoh: 3, 6, atau 9">
        <div id="jumlahAkunError" class="error-message"></div>

        <label for="totalHargaDisplay">3. Total Harga:</label>
        <div id="totalHargaDisplay" class="harga-display">Rp 0</div>

        <button id="tombolBayar" disabled>Bayar</button>
    </div>

    <hr>

    <div class="container" id="statusCheckContainer">
        <h2>üîç Cek Status Pembayaran</h2>
        <label for="transactionIdInput">Masukkan ID Transaksi Anda:</label>
        <input type="text" id="transactionIdInput" placeholder="Contoh: 1321 atau TRXXYZ">
        <button onclick="startListeningForStatus()">Cek Status</button>

        <div id="paymentStatus" class="status-info">Masukkan ID dan klik "Cek Status"</div>
        <p id="lastChecked"></p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <script>
        // Konfigurasi Firebase Anda (sudah diisi dengan data yang Anda berikan sebelumnya)
        const firebaseConfig = {
          apiKey: "AIzaSyDA_T-LRjANUHG1ZLqKG1vwD_Wu9hpzWz4",
          authDomain: "statuspembayaran-b7a1f.firebaseapp.com",
          databaseURL: "https://statuspembayaran-b7a1f-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "statuspembayaran-b7a1f",
          storageBucket: "statuspembayaran-b7a1f.firebasestorage.app",
          messagingSenderId: "619692483603",
          appId: "1:619692483603:web:b6c37409717b8ca89bcbe6",
          measurementId: "G-28H2HJGVTC"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // === LOGIKA UNTUK FORM PEMESANAN ===
        const kategoriAkunSelect = document.getElementById('kategoriAkun');
        const jumlahAkunInput = document.getElementById('jumlahAkun');
        const totalHargaDisplay = document.getElementById('totalHargaDisplay');
        const jumlahAkunError = document.getElementById('jumlahAkunError');
        const tombolBayar = document.getElementById('tombolBayar');

        const hargaPerBlok = 100000; // Rp 100.000
        const ukuranBlok = 3; // per 3 akun

        function formatRupiah(angka) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
        }

        function perbaruiTotalHarga() {
            const jumlah = parseInt(jumlahAkunInput.value);
            jumlahAkunError.textContent = ''; // Bersihkan pesan error sebelumnya
            tombolBayar.disabled = true; // Nonaktifkan tombol bayar secara default

            if (isNaN(jumlah)) {
                totalHargaDisplay.textContent = formatRupiah(0);
                // Tidak perlu pesan error jika kosong, hanya jika ada input tapi tidak valid
                if (jumlahAkunInput.value !== "") {
                     jumlahAkunError.textContent = 'Masukkan angka yang valid.';
                }
                return;
            }

            if (jumlah < ukuranBlok) {
                jumlahAkunError.textContent = `Jumlah minimal adalah ${ukuranBlok} akun.`;
                totalHargaDisplay.textContent = formatRupiah(0);
                return;
            }

            if (jumlah % ukuranBlok !== 0) {
                jumlahAkunError.textContent = `Jumlah harus dalam kelipatan ${ukuranBlok} (misalnya: ${ukuranBlok}, ${ukuranBlok*2}, ${ukuranBlok*3}, dst.).`;
                totalHargaDisplay.textContent = formatRupiah(0);
                return;
            }

            // Jika semua validasi lolos
            const totalHarga = (jumlah / ukuranBlok) * hargaPerBlok;
            totalHargaDisplay.textContent = formatRupiah(totalHarga);
            tombolBayar.disabled = false; // Aktifkan tombol bayar
        }

        jumlahAkunInput.addEventListener('input', perbaruiTotalHarga);

        tombolBayar.addEventListener('click', function() {
            const kategoriTerpilih = kategoriAkunSelect.options[kategoriAkunSelect.selectedIndex].text;
            const jumlah = parseInt(jumlahAkunInput.value);
            const totalHarga = (jumlah / ukuranBlok) * hargaPerBlok;

            if (tombolBayar.disabled) {
                alert("Harap perbaiki input jumlah akun terlebih dahulu.");
                return;
            }
            
            // Untuk sekarang, kita hanya tampilkan alert.
            // Nantinya, di sini Anda bisa menambahkan logika untuk:
            // 1. Generate ID Transaksi unik.
            // 2. Menyimpan detail pesanan ini (kategori, jumlah, total harga, ID transaksi) ke Firebase atau Google Sheet dengan status awal "Menunggu Pembayaran".
            // 3. Mengarahkan pengguna ke halaman pembayaran atau memberikan instruksi pembayaran.
            alert(`Detail Pesanan:\nKategori: ${kategoriTerpilih}\nJumlah: ${jumlah} akun\nTotal Bayar: ${formatRupiah(totalHarga)}\n\nSilakan lanjutkan ke proses pembayaran (detail proses belum diimplementasikan).`);
            
            // Setelah ini, pengguna akan melakukan pembayaran, dan ID Transaksi dari proses tersebut
            // akan digunakan di bagian "Cek Status Pembayaran" di bawah.
        });

        // === LOGIKA UNTUK CEK STATUS PEMBAYARAN (SUDAH ADA SEBELUMNYA) ===
        let currentTransactionId = null;
        let paymentStatusRef = null;
        const STATUS_BERHASIL_DARI_SHEET = "Lunas";

        function startListeningForStatus() {
            const transactionIdInput = document.getElementById('transactionIdInput');
            const newTransactionId = transactionIdInput.value.trim();
            const statusDiv = document.getElementById('paymentStatus');
            const lastCheckedP = document.getElementById('lastChecked');

            if (!newTransactionId) {
                statusDiv.textContent = 'ID Transaksi tidak boleh kosong.';
                statusDiv.className = 'paymentStatus status-error';
                return;
            }

            if (paymentStatusRef && (newTransactionId !== currentTransactionId || paymentStatusRef)) {
                paymentStatusRef.off();
                console.log(`Listener untuk ID ${currentTransactionId} dihentikan.`);
                paymentStatusRef = null; 
            }
            
            currentTransactionId = newTransactionId;
            console.log(`Memulai listener untuk ID Transaksi: ${currentTransactionId}`);

            statusDiv.textContent = `Mengecek status untuk ${currentTransactionId}...`;
            statusDiv.className = 'paymentStatus status-info';
            lastCheckedP.textContent = '';

            const path = `pembayaran/${currentTransactionId}`;
            paymentStatusRef = database.ref(path);

            paymentStatusRef.on('value', (snapshot) => {
                const data = snapshot.val();
                const timestamp = new Date();
                lastCheckedP.textContent = 'Data terakhir dicek: ' + timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                console.log("Data diterima dari Firebase:", data);

                if (data) {
                    if (data.status && data.status.trim().toLowerCase() === STATUS_BERHASIL_DARI_SHEET.trim().toLowerCase()) {
                        statusDiv.textContent = 'Pembayaran Berhasil!';
                        statusDiv.className = 'paymentStatus status-success';
                    } else {
                        statusDiv.textContent = `Status: ${data.status || 'Menunggu Update'}`;
                        statusDiv.className = 'paymentStatus status-pending';
                    }
                } else {
                    statusDiv.textContent = 'Data transaksi tidak ditemukan.';
                    statusDiv.className = 'paymentStatus status-notfound';
                }
            }, (error) => {
                console.error("Error membaca dari Firebase:", error);
                statusDiv.textContent = 'Gagal mengambil data dari Firebase.';
                statusDiv.className = 'paymentStatus status-error';
            });
        }

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const trxIdFromUrl = urlParams.get('trx');
            if (trxIdFromUrl) {
                document.getElementById('transactionIdInput').value = trxIdFromUrl;
                startListeningForStatus();
            }
            perbaruiTotalHarga(); // Panggil sekali saat load untuk inisialisasi status tombol bayar
        };
    </script>
</body>
</html>
